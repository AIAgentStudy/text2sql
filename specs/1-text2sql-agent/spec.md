# Feature Specification: Text2SQL Agent

**Feature Branch**: `1-text2sql-agent`
**Created**: 2025-01-30
**Status**: Draft
**Input**: User description: "text2sql Agent를 만들꺼야. 유저가 자연어로 물어보면 sql문을 만들어줘서 DB에서 조회를 할 수 있게 해줄꺼고. langgraph를 이용할꺼야. update, delete같은 위험한 쿼리는 만들면 안되고 조회 요청만 만들어주는 agent야. 비개발자들이 주로 사용할 것이니 개발언어를 전혀 모르는 사람도 편히 사용할 수 있어야하고, 제대로 검증된 쿼리를 답변으로 보내야해. 사용친화적 인터페이스를 구성하려고해."

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 자연어 질문으로 데이터 조회하기 (Priority: P1)

비개발자 사용자가 일상적인 한국어로 데이터베이스에 질문을 하면, 시스템이 이를 이해하고 적절한 조회 결과를 보여준다. 사용자는 SQL이나 프로그래밍 언어를 전혀 알 필요가 없다.

**Why this priority**: 핵심 가치 제안. 비개발자가 기술적 장벽 없이 데이터에 접근할 수 있게 하는 것이 이 Agent의 존재 이유이다.

**Independent Test**: 사용자가 "지난달 매출 상위 10개 제품이 뭐야?"라고 입력하면 해당 데이터가 표시되는지 확인하여 테스트 가능.

**Acceptance Scenarios**:

1. **Given** 사용자가 시스템에 접속한 상태, **When** "이번 달 신규 고객이 몇 명이야?"라고 입력, **Then** 신규 고객 수가 읽기 쉬운 형태로 표시됨
2. **Given** 사용자가 시스템에 접속한 상태, **When** "최근 일주일간 가장 많이 팔린 상품 5개 보여줘"라고 입력, **Then** 상위 5개 상품 목록이 테이블 형태로 표시됨
3. **Given** 사용자가 질문을 입력한 상태, **When** 쿼리 실행이 완료됨, **Then** 결과와 함께 "조회 완료" 상태 메시지가 표시됨

---

### User Story 2 - 위험한 쿼리 차단 (Priority: P1)

시스템은 UPDATE, DELETE, DROP, INSERT 등 데이터를 변경하거나 삭제하는 요청을 절대로 생성하지 않는다. 사용자가 의도적으로 또는 실수로 이러한 요청을 해도 안전하게 차단된다.

**Why this priority**: 보안과 데이터 무결성은 타협할 수 없는 핵심 요구사항이다. P1과 동일한 우선순위로 반드시 함께 구현되어야 한다.

**Independent Test**: 다양한 데이터 변경 요청을 시도하고 모두 차단되는지 확인하여 테스트 가능.

**Acceptance Scenarios**:

1. **Given** 사용자가 시스템에 접속한 상태, **When** "고객 정보를 삭제해줘"라고 입력, **Then** 시스템이 거절 메시지를 표시하고 어떤 쿼리도 실행하지 않음
2. **Given** 사용자가 시스템에 접속한 상태, **When** "가격을 1000원으로 변경해줘"라고 입력, **Then** 시스템이 "조회 요청만 가능합니다"라는 안내 메시지를 표시
3. **Given** 생성된 SQL 쿼리가 있는 상태, **When** 쿼리에 UPDATE/DELETE/INSERT/DROP 등이 포함됨, **Then** 쿼리가 실행되지 않고 오류 처리됨

---

### User Story 3 - 쿼리 검증 및 결과 미리보기 (Priority: P2)

사용자가 질문을 하면 시스템이 생성한 SQL 쿼리를 이해하기 쉬운 설명과 함께 보여주고, 실행 전에 확인할 기회를 제공한다.

**Why this priority**: 신뢰성 확보. 사용자가 원하는 정보가 맞는지 확인하고 실수를 방지할 수 있다.

**Independent Test**: 질문 후 생성된 쿼리의 한국어 설명이 표시되고, 사용자가 확인/취소할 수 있는지 테스트.

**Acceptance Scenarios**:

1. **Given** 사용자가 질문을 입력한 상태, **When** 쿼리가 생성됨, **Then** "이 질문은 [한국어 설명]을 조회합니다. 실행할까요?"라는 확인 메시지 표시
2. **Given** 확인 메시지가 표시된 상태, **When** 사용자가 "취소"를 선택, **Then** 쿼리가 실행되지 않고 새 질문을 입력할 수 있는 상태로 돌아감
3. **Given** 확인 메시지가 표시된 상태, **When** 사용자가 "실행"을 선택, **Then** 쿼리가 실행되고 결과가 표시됨

---

### User Story 4 - 오류 상황 안내 (Priority: P2)

시스템이 사용자의 질문을 이해하지 못하거나, 데이터베이스에 해당 정보가 없거나, 기타 오류가 발생하면 비개발자도 이해할 수 있는 친절한 안내 메시지를 제공한다.

**Why this priority**: 사용자 경험. 오류 상황에서도 사용자가 좌절하지 않고 다시 시도할 수 있도록 도와야 한다.

**Independent Test**: 모호한 질문, 존재하지 않는 테이블 참조, 네트워크 오류 등 다양한 오류 상황에서 친절한 메시지가 표시되는지 확인.

**Acceptance Scenarios**:

1. **Given** 사용자가 시스템에 접속한 상태, **When** 모호하거나 이해할 수 없는 질문 입력, **Then** "죄송합니다. 질문을 이해하지 못했어요. '지난달 매출은?' 처럼 구체적으로 질문해 주세요."라는 도움말 표시
2. **Given** 정상적인 질문을 입력한 상태, **When** 데이터베이스 연결 오류 발생, **Then** "현재 데이터를 가져올 수 없습니다. 잠시 후 다시 시도해 주세요."라는 안내 메시지 표시
3. **Given** 정상적인 쿼리가 실행된 상태, **When** 결과가 0건임, **Then** "조건에 맞는 데이터가 없습니다."라는 안내와 함께 빈 결과 표시

---

### User Story 5 - 대화 맥락 유지 (Priority: P3)

사용자가 연속적인 질문을 할 때 이전 대화 맥락을 기억하여 더 자연스러운 대화가 가능하다.

**Why this priority**: 편의성 향상. 핵심 기능은 아니지만 사용자 경험을 크게 개선한다.

**Independent Test**: "지난달 매출 보여줘" → "그중에 서울 지역만" 형태의 연속 질문이 정상 동작하는지 확인.

**Acceptance Scenarios**:

1. **Given** "지난달 매출 상위 10개 보여줘"를 질문한 상태, **When** "그중에서 식품 카테고리만 보여줘"라고 입력, **Then** 이전 결과에서 식품 카테고리만 필터링하여 표시
2. **Given** 대화가 진행 중인 상태, **When** 사용자가 "처음부터 다시"라고 입력, **Then** 대화 맥락이 초기화되고 새로운 질문 시작

---

### Edge Cases

- 사용자가 SQL 구문을 직접 입력하면 어떻게 되는가? → 일반 자연어처럼 처리하되, 위험 쿼리 검증은 동일하게 적용
- 매우 복잡한 질문(여러 테이블 조인, 다중 조건)은 어떻게 처리되는가? → 가능한 범위 내에서 처리하고, 불가능하면 질문을 나눠달라고 안내
- 데이터베이스 스키마가 변경되면 어떻게 되는가? → 스키마 정보를 재로딩하고, 없는 컬럼 참조 시 친절한 오류 메시지
- 대용량 결과(수천 건 이상)는 어떻게 표시되는가? → 페이지네이션 또는 상위 N건만 표시하고 나머지는 내보내기 옵션 제공
- 동시에 여러 사용자가 접속하면 어떻게 되는가? → 각 사용자의 세션은 독립적으로 관리

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 시스템은 한국어 자연어 질문을 이해하고 의미를 파악해야 한다
- **FR-002**: 시스템은 자연어 질문을 유효한 SQL SELECT 쿼리로 변환해야 한다
- **FR-003**: 시스템은 SELECT 문만 생성해야 하며, UPDATE/DELETE/INSERT/DROP/ALTER/TRUNCATE 등 데이터 변경 쿼리는 절대 생성하지 않아야 한다
- **FR-004**: 시스템은 생성된 모든 SQL 쿼리를 실행 전에 위험 키워드 검증을 수행해야 한다
- **FR-005**: 시스템은 생성된 쿼리를 사용자가 이해할 수 있는 한국어로 설명해야 한다
- **FR-006**: 시스템은 쿼리 실행 전 사용자 확인을 받아야 한다
- **FR-007**: 시스템은 쿼리 결과를 읽기 쉬운 테이블 형태로 표시해야 한다
- **FR-008**: 시스템은 모든 오류 상황에서 비개발자가 이해할 수 있는 한국어 안내 메시지를 제공해야 한다
- **FR-009**: 시스템은 대화 맥락을 세션 내에서 유지하여 후속 질문을 처리할 수 있어야 한다
- **FR-010**: 시스템은 데이터베이스 스키마 정보를 참조하여 정확한 테이블/컬럼명을 사용해야 한다
- **FR-011**: 시스템은 대용량 결과(100건 초과)에 대해 페이지네이션을 제공해야 한다
- **FR-012**: 시스템은 LangGraph 기반으로 Agent 워크플로우를 구성해야 한다

### Key Entities

- **Query Request**: 사용자의 자연어 질문, 세션 ID, 타임스탬프, 대화 맥락
- **Generated Query**: 생성된 SQL 문, 한국어 설명, 검증 상태, 예상 결과 유형
- **Query Result**: 조회 결과 데이터, 행 수, 컬럼 정보, 실행 시간
- **Conversation Session**: 세션 ID, 사용자 식별자, 대화 히스토리, 생성 시간, 마지막 활동 시간
- **Database Schema**: 테이블 목록, 각 테이블의 컬럼 정보, 컬럼 설명(한국어)

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 비개발자 사용자가 첫 질문에서 원하는 데이터를 얻는 비율이 80% 이상이어야 한다
- **SC-002**: 자연어 질문 입력부터 결과 표시까지 10초 이내에 완료되어야 한다
- **SC-003**: 위험 쿼리(UPDATE/DELETE/INSERT/DROP 등) 차단율이 100%이어야 한다
- **SC-004**: 시스템 오류 발생 시 사용자가 이해 가능한 안내 메시지 표시율이 100%이어야 한다
- **SC-005**: 연속 질문(맥락 유지)의 정확도가 70% 이상이어야 한다
- **SC-006**: 동시 접속 사용자 50명 이상을 지원해야 한다
- **SC-007**: 사용자 만족도 조사에서 "사용하기 쉽다" 응답률이 85% 이상이어야 한다

## Clarifications

### Session 2025-01-30

- Q: 사용자가 이 Agent와 상호작용하는 방식은? → A: 웹 채팅 UI (브라우저 기반 대화형 인터페이스). 향후 Google Sheets, Slack 연동 고려.
- Q: 주로 연결할 데이터베이스 종류는? → A: PostgreSQL (pgvector 확장 포함)
- Q: Text-to-SQL 변환에 사용할 LLM은? → A: OpenAI GPT-4 (기본), Anthropic Claude 및 Google Gemini 추가 지원
- Q: 데이터베이스 스키마 정보를 어떻게 가져올까? → A: DB 메타데이터에서 직접 조회 (information_schema, pg_catalog)

## Assumptions

- 사용자 인터페이스는 웹 기반 채팅 UI로 제공 (향후 Google Sheets, Slack 연동 확장 가능)
- 대상 데이터베이스는 PostgreSQL (pgvector 확장 지원 포함)
- 데이터베이스 스키마 정보는 DB 메타데이터(information_schema, pg_catalog)에서 직접 조회
- 인증/권한 관리는 이 기능 범위 외로, 시스템에 접속한 사용자는 조회 권한이 있다고 가정
- 주요 사용 언어는 한국어로, 한국어 자연어 처리에 최적화
- LLM 제공자: OpenAI GPT-4 (기본), Anthropic Claude 및 Google Gemini 추가 지원 (설정으로 전환 가능)
- 세션 타임아웃은 30분으로 설정하고, 이후 대화 맥락 초기화
